# 自动同步上游仓库 (rust-lang/rust) 到 fork 仓库
# 每天自动运行，保持 fork 的 main 分支与上游同步
#
# 使用方法：
# 1. 在 fork 仓库的 Settings > Secrets and variables > Actions 中配置:
#    - UPSTREAM_REPO: rust-lang/rust
#    - PAT: Personal Access Token (需要有 repo 权限)
# 2. 手动触发: GitHub 页面 > Actions > Sync Upstream > Run workflow

name: Sync Upstream

on:
  # 每天自动运行（UTC 时间 00:00）
  schedule:
    - cron: '0 0 * * *'
  # 允许手动触发
  workflow_dispatch:
    inputs:
      force:
        description: '强制同步（即使上游没有新提交）'
        required: false
        type: boolean
        default: false

# 防止并发运行
concurrency:
  group: sync-upstream
  cancel-in-progress: false

jobs:
  sync:
    name: Sync with upstream
    runs-on: ubuntu-latest
    # 只在 main 分支上运行
    if: github.repository_owner == 'ViewWay' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # 使用 PAT 而不是默认的 GITHUB_TOKEN，以便能够推送到 fork
          token: ${{ secrets.PAT }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ secrets.UPSTREAM_REPO }}
          git fetch upstream

      - name: Check for new commits
        id: check-commits
        run: |
          LOCAL=$(git rev-parse main)
          REMOTE=$(git rev-parse upstream/main)
          echo "local: $LOCAL"
          echo "remote: $REMOTE"

          if [ "$LOCAL" != "$REMOTE" ] || [ "${{ inputs.force }}" == "true" ]; then
            echo "has_new_commits=true" >> $GITHUB_OUTPUT
            echo "new_commits: $(git rev-list --count $LOCAL..upstream/main)" >> $GITHUB_OUTPUT
          else
            echo "has_new_commits=false" >> $GITHUB_OUTPUT
          fi

      - name: Merge upstream changes
        if: steps.check-commits.outputs.has_new_commits == 'true'
        run: |
          # 切换到 main 分支
          git checkout main

          # 合并上游的 main 分支
          # 使用 --strategy-option=theirs 以优先采用上游的更改
          git merge upstream/main --no-edit --strategy-option=theirs

          # 推送到 fork 仓库
          git push origin main

      - name: Create summary
        if: steps.check-commits.outputs.has_new_commits == 'true'
        run: |
          echo "## 同步成功 :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- 上游仓库: \`${{ secrets.UPSTREAM_REPO }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- 新提交数: ${{ steps.check-commits.outputs.new_commits }}" >> $GITHUB_STEP_SUMMARY
          echo "- 时间: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: No new commits
        if: steps.check-commits.outputs.has_new_commits == 'false'
        run: |
          echo "## 无需同步 :zzz:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "上游仓库没有新的提交，main 分支已是最新。" >> $GITHUB_STEP_SUMMARY
